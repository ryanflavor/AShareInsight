# **7. 错误处理与日志记录策略**

## **7.1 API层的错误处理：全局异常捕获**

  * **策略**: 在`interfaces/api/`模块中设置一个**全局异常处理器 (Global Exception Handler)**。此中间件将捕获所有未处理的异常，并将其转化为标准化的JSON错误响应。
  * **自定义异常**: 具体的业务异常将在`src/shared/exceptions/`中定义。
  * **标准错误响应体**:
    ```json
    {
      "error": {
        "code": "INTERNAL_SERVER_ERROR",
        "message": "系统内部发生未知错误，请联系管理员。",
        "request_id": "uuid-..." 
      }
    }
    ```

## **7.2 离线数据管道的错误处理：高容错性**

  * **策略**: 数据处理流程需具备容错能力，不能因单个文件失败而中断。
  * **实现**:
    1.  **独立事务**: 每个文档的处理都是一个独立的事务。
    2.  **“死信队列”**: 处理失败的文档将被移入一个专门的列表或表中，并记录错误信息，以便人工排查。
    3.  **持续执行**: 管道将跳过失败的文档，继续处理下一个。

## **7.3 统一的结构化日志**

  * **策略**: 所有模块都将使用统一的、结构化的日志记录服务。
  * **实现**:
    1.  **JSON格式**: 所有日志以结构化的JSON格式输出。
    2.  **链路追踪**: 在`infrastructure/monitoring/`中集成`OpenTelemetry`，为API请求和后台任务生成唯一的`request_id`或`trace_id`，并将其包含在所有相关日志中，以便追踪完整的处理链路。

-----
